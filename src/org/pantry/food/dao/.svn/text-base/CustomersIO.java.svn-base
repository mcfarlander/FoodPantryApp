/*
  Copyright 2011 Dave Johnson

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
*/
package org.pantry.food.io;

import au.com.bytecode.opencsv.CSVReader;
import au.com.bytecode.opencsv.CSVWriter;
import java.io.File;
import java.io.FileNotFoundException;

import java.io.FileReader;
import java.io.IOException;
import java.io.FileWriter;
import java.util.ArrayList;

import org.pantry.food.FormState;


/**
 *
 * @author mcfarland_davej
 */
public class CustomersIO {

    private String startDir = "";
    
    private ArrayList<Customer> customerList = new ArrayList<Customer>();

    public ArrayList<Customer> getCustomerList(){return this.customerList;}
    public int getCustomerCount(){return this.customerList.size();}

    public void setStartDir(String sDir){this.startDir = sDir;}

    private static final int CUSTOMERID         = 0;
    private static final int HOUSEHOLDID        = 1;
    private static final int PERSONID           = 2;
    private static final int GENDER             = 3;
    private static final int BIRTHDATE          = 4;
    private static final int AGE                = 5;
    private static final int MONTHREGISTERED    = 6;
    private static final int NEWCUSTOMER        = 7;
    private static final int COMMENTS           = 8;
    private static final int ACTIVE             = 9;

    private static final String Col_CustomerId = "customerid";
    private static final String Col_HouseholdId = "householdid";
    private static final String Col_PersonId = "personid";
    private static final String Col_Gender = "gender";
    private static final String Col_BirthDate = "birthdate";
    private static final String Col_Age = "age";
    private static final String Col_MonthRegistered = "monthregistered";
    private static final String Col_NewCustomer = "new";
    private static final String Col_Comments = "comments";
    private static final String Col_Active = "active";

    /**
     * Reads in the entire contents of the CSV file for customers.
     * @throws FileNotFoundException
     * @throws IOException
     */
    public void readCsvFile() throws FileNotFoundException, IOException{

        System.out.println("CustomersIO.readCsvFile");

        if (startDir.length() == 0){
            startDir = new java.io.File(".").getCanonicalPath();
        }

        System.out.println("Cvs Path:" + startDir + "/" + FormState.getInstance().getCsvFileCustomers());
        File file = new File(startDir + "/" + FormState.getInstance().getCsvFileCustomers());
        customerList = new ArrayList<Customer>();

        if (file.exists()){

            System.out.println("Customers cvs file found");
            //read in the whole file into a list
            FileReader fr = new FileReader(file);
            CSVReader reader = new CSVReader(fr);

            String [] nextLine;
            boolean firstLine = true;
            while ((nextLine = reader.readNext()) != null) {
                // nextLine[] is an array of values from the line
               // System.out.println(nextLine.length + " etc...");

                if (!firstLine){
                    Customer cust = new Customer();
                    cust.setCustomerId(Integer.parseInt(nextLine[CUSTOMERID]));
                    cust.setHouseholdId(Integer.parseInt(nextLine[HOUSEHOLDID]));
                    cust.setPersonId(Integer.parseInt(nextLine[PERSONID]));
                    cust.setGender(nextLine[GENDER]);
                    cust.setBirthDate(nextLine[BIRTHDATE]);
                    cust.setAge(Integer.parseInt(nextLine[AGE]));
                    cust.setMonthRegistered(Integer.parseInt(nextLine[MONTHREGISTERED]));
                    cust.setNewCustomer(Boolean.parseBoolean(nextLine[NEWCUSTOMER]));
                    cust.setComments(nextLine[COMMENTS]);
                    cust.setActive(Boolean.parseBoolean(nextLine[ACTIVE]));

                    customerList.add(cust);

                } else {
                    firstLine = !firstLine;
                }

            }


        } else {
            System.out.println("Customers cvs file NOT found");
        }


    }// end of readCsvFile

    /**
     * Saves all items back to the CSV file for customers.
     * @throws IOException
     */
    public void saveCsvFile() throws IOException{

        System.out.println("CustomersIO.saveCsvFile");
        if (startDir.length() == 0){
            startDir = new java.io.File(".").getCanonicalPath();
        }

        System.out.println("Cvs Path:" + startDir + "/" + FormState.getInstance().getCsvFileCustomers());
        File file = new File(startDir + "/" + FormState.getInstance().getCsvFileCustomers());

        if (file.exists()){
            System.out.println("deleting old file");
            file.delete();
        }

        System.out.println("creating and saving to csv file");
        FileWriter fw = new FileWriter(file);
        CSVWriter writer = new CSVWriter(fw);

        // add the column titles
        String[] titles = {Col_CustomerId, Col_HouseholdId,
            Col_PersonId, Col_Gender,
            Col_BirthDate, Col_Age,
            Col_MonthRegistered, Col_NewCustomer,
            Col_Comments, Col_Active
        };

        writer.writeNext(titles);

        for (int i = 0; i < customerList.size(); i++){
            Customer cust = customerList.get(i);
            writer.writeNext(cust.getCvsEntry());

        }

        writer.close();

    }

    /*
     * Adds a customer object to the customer list in memory.
     */
    public void addCustomer(Customer cust){
        customerList.add(cust);
    }

    /**
     * Modifies a customer object in the list (in memory).
     * @param cust
     */
    public void editCustomer(Customer cust){

        for (int i = 0; i < customerList.size(); i++){

            Customer testCust = customerList.get(i);
            if (testCust.getCustomerId() == cust.getCustomerId()){

                testCust.setHouseholdId(cust.getHouseholdId());
                testCust.setPersonId(cust.getPersonId());
                testCust.setGender(cust.getGender());
                testCust.setBirthDate(cust.getBirthDate());
                testCust.setAge(cust.getAge());
                testCust.setMonthRegistered(cust.getMonthRegistered());
                testCust.setNewCustomer(cust.isNewCustomer());
                testCust.setComments(cust.getComments());
                testCust.setActive(cust.isActive());

                break;
            }
        }

    }// end of editCustomer

    /*
     * Deletes a customer object from the list in memory.
     */
    public void deleteCustomer(Customer cust){

        for (int i = 0; i < customerList.size(); i++){

            Customer testCust = customerList.get(i);
            if (testCust.getCustomerId() == cust.getCustomerId()){
                customerList.remove(i);
                break;
            }
        }

    }// end of deleteCustomer

}// end of class
